!function(e){"use strict";function t(e,t,n,r,i,o,a,s){function c(e){"qb"==e?l.qbOfferList=[]:"market"==e&&(l.marketOfferList=[])}function f(e){if(!(n.filter.province.length&&n.filter.province.indexOf(e.province)==-1||"inner"==i&&n.filter.quote_type!=e.quote_type)){o.trustType;if("offline"!=i||!("IBD"!=e.quote_type||"1"==n.filter.trust_type&&e.trust_type&&n.filter.trust_type!=e.trust_type)){if(n.filter.direction!==e.direction){var t=l[l.state+"OfferList"];return void(t&&e.id&&(l[l.state+"OfferList"]=t.findWhere(function(t){return t.id!==e.id})))}n.matrix.length&&!w(e.bank_nature)||n.matrix.length&&!O(e.quote_period)||n.isActive&&0==e.active||n.isSelf&&s.getUserId()!=e.quote_userid||k(e)&&("qb"==l.state&&"PRIME_QB"==e.source?b(e):"market"==l.state&&b(e))}}}function u(e){if(e){var t=function(e,t){"QQ"!=e.source&&e.quote_user_list&&e.quote_user_list.forEach(function(e){e.qb_id==t.qb_id&&(e.status=t.new_state)})};e.forEach(function(e){"qb"==l.state?l.qbOfferList&&l.qbOfferList.forEach(function(n){t(n,e)}):"market"==l.state&&l.marketOfferListmarketOfferList&&l.marketOfferList.forEach(function(n){t(n,e)})})}}var l=this;n.initOptions(),l.financingType=i,"inner"==i?n.setFinancingType("inner"):"offline"==i&&n.setFinancingType("offline"),l.state="qb";var d=function(){l.qbPage=1,l.marketPage=1};d(),l.initData=function(e){e||(e=l.state),d(),c(l.state),l.isLoading=!0;var t=function(){l.state="qb",n.getQbOfferList(1,!0).success(function(e){l.qbOfferList=e.result,l.qbTotalPageCount=e.total_page_count,l.isLoading=!1})},r=function(){l.state="market",n.getMarketOfferList(1,!0).success(function(e){l.marketOfferList=e.result,l.marketTotalPageCount=e.total_page_count,l.isLoading=!1})};switch(e){case"qb":t();break;case"market":r()}},l.switchOfferType=function(e){e!=l.state&&l.initData(e)};var p={"机构":"INSTITUTE","QB用户":"CONTACT","QQ用户":"QQ","备注":"MEMO"};l.clickSearchInput=function(){l.openDropdown=!l.openDropdown},l.clickSearchClose=function(){l.searchKeyword="",g()},l.memoType="备注";var y=_.debounce(function(){l.searchKeyword&&(n.searchKeyword(l.searchKeyword).success(function(e){var t=e.result;l.orgList=t[0].list,l.orgType=t[0].type,l.qbUserList=t[1].list,l.qbUserType=t[1].type,l.qqUserList=t[2].list,l.qqUserType=t[2].type,l.memoWord=l.searchKeyword,l.openDropdown=!0}),e.$apply())},300);l.searchMemo=function(){l.openDropdown=!1,n.searchType=p[l.memoType],n.keyword=l.searchKeyword,l.initData(l.state)};var m=function(e,t){l.openDropdown=!1,n.searchType=p[e],n.keyword=t,l.initData(l.state)},g=function(){n.searchKeyword(l.searchKeyword).success(function(e){for(var t,n,r=e.result,i=!1,o=0;o<=2;o++)if(r[o].list.length>0){t=r[o].type,n=r[o].list[0].id,i=!0,l.searchKeyword=r[o].list[0].name;break}i||(n=l.searchKeyword,t=l.memoType),m(t,n)})};l.searchKeyup=function(e){return e.ctrlKey===!0&&e.altKey&&120===e.keyCode?void s.logout():void(13==e.keyCode?g():l.searchKeyword&&l.searchKeyword.length>1?y():(l.openDropdown=!1,void 0!=l.searchKeyword&&l.searchKeyword.length<=0&&l.searchMemo()))},l.selectSearch=function(e,t,r){$(e.target).parents(".dropdown-menu").prev().focus(),l.searchKeyword=t.name,n.keyword=t.id,n.searchType=p[r],l.initData(l.state)},l.loadQbData=function(e){var t=l.qbTotalPageCount;l.qbPage>=t||(l.qbPage++,n.getQbOfferList(l.qbPage).success(function(n){l.qbOfferList=l.qbOfferList.concat(n.result),"function"==typeof e&&e(l.qbPage,t)}))},l.loadMarketData=function(e){var t=l.marketTotalPageCount;l.marketPage>=t||(l.marketPage++,n.getMarketOfferList(l.marketPage).success(function(n){l.marketOfferList=l.marketOfferList.concat(n.result),"function"==typeof e&&e(l.marketPage,t)}))},l.manageOffer=function(){({inner:"OUT",offline:"IN"})[i];r.openModal(function(e){})},l.changeFilter=function(){n.isActive=l.isActive,n.isSelf=l.isSelf,l.initData(l.state)},e.$on("refreshList",function(e,t){l.initData(l.state),!t.target||t.matrixCellType&&"showAll"===t.matrixCellType||l.switchOfferType("market")});var h=n.connectWebSocket();h.onopen=function(){console.log("open")},h.onmessage=function(n){if(n.data){if("ping"===n.data)return void console.log("Received ping for keeping wsandlocalmessage connection.");var r=JSON.parse(n.data);if(console.log(r),0===r.return_code){var i=r.result;1===r.return_type?u(i):2===r.return_type&&i.forEach(function(e){e.isNew=!0,f(e),a(function(){e.isNew=!1},500)})}}t.safeApply(e)},h.onclose=function(e){console.log("close")};var k=function(e){if(n.keyword)switch(n.searchType){case"INSTITUTE":if(e.institution_name.indexOf(n.keyword)==-1)return!1;break;case"CONTACT":case"QQ":if(e.quote_username.indexOf(n.keyword)==-1)return!1;break;case"MEMO":if(e.memo.indexOf(n.keyword)==-1)return!1}return!0},v=["1","3","4","6"],w=function(e){var t=o.bankNature;return"OTHERS"==n.matrix[0].type?v.indexOf(e)==-1:t[n.matrix[0].type]==e},O=function(e){var t=o.period[n.matrix[0].period[0]],r=function(e){var t=parseInt(e);return isNaN(t)||e.indexOf("D")>-1||(e.indexOf("M")>-1?t=30*t:e.indexOf("Y")>-1&&(t=365*t)),t},i=r(e);return i>=t.min&&i<=t.max},b=function(t){var n=l[l.state+"OfferList"];if(n){var r=n.length;if("0"===t.active)t.id&&(n=n.findWhere(function(e){return e.id!==t.id}));else{if(!(n instanceof Array))return;var i=n.indexOfItem(function(e){return e.id===t.id});if(i>=0)n[i]=t;else{var o=[t];o.push.apply(o,n),n=o}}n.length>r&&n.length>200&&n.splice(n.length-1,1),l[l.state+"OfferList"]=n,e.$broadcast("hasNewData")}};e.$on("$destroy",function(){h.close()}),e.$on("toTableInstitution",function(t,r){l.searchKeyword=r.name,n.keyword=r.id,n.searchType=p["机构"],l.isSelf=!1,l.isActive=!1,n.isSelf=!1,n.isActive=!1,e.$emit("filterChanged")})}e.module("moneyMarketApp").controller("tableController",t),t.$inject=["$scope","commonService","tableService","offerService","financingType","enumConfig","$timeout","userinfoService"]}(window.angular);