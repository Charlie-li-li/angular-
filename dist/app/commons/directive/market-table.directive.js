!function(t){"use strict";t.module("directives").directive("marketTable",function(){var t=["$http","$scope","$q","$uibModal","enumConfig","uiGridConstants","appConfig","offerService","qbService","contactService","sortService","$timeout","$window","$location",function(t,i,e,o,n,a,r,l,c,s,p,d,m,g){i.window=m,i.location=g;var u=this;u.showToTop=!1,u.hasNewData=!1;var f=new Date;f.setHours(0),f.setMinutes(0),f.setSeconds(0),f.setMilliseconds(0),u.today=f.getTime(),u.enumConfig=n,i.$watch("vm.list",function(t,i){t&&(u.gridOptions.data=t)},!0),u.getDataDown=function(){var t=e.defer();return u.loadData({callback:function(i,e){u.gridApi.infiniteScroll.saveScrollPercentage(),u.gridApi.infiniteScroll.dataLoaded(!0,i<=e).then(function(){t.resolve()})}}),t.promise},u.scrollingTop=function(){u.hasNewData=!1,u.showToTop=!1;var t=e.defer();return u.gridApi.infiniteScroll.saveScrollPercentage(),u.gridApi.infiniteScroll.dataLoaded(!0,!0).then(function(){t.resolve()}),t.promise},i.$watch("vm.gridApi.grid.isScrollingVertically",function(t){t&&(u.showToTop=!0)}),i.$on("hasNewData",function(){u.showToTop&&(u.hasNewData=!0)}),u.scrollToTop=function(){u.gridApi.core.scrollTo(u.gridOptions.data[0]),u.showToTop=!1,u.hasNewData=!1},u.getArray=function(t){if(t)return t.split(/,|;/)};u.clickQQ=function(t,i){document.oncopy=function(t){t.clipboardData.setData("text/plain",i.quote_userid),t.preventDefault()},document.execCommand("copy"),u.copyqqsuccess=!0;var e=document.getElementById("qqcopy");e.style.left=+t.clientX+190+"px",e.style.top=+t.clientY-70+"px",u.qqnumber=i.quote_userid;var o;o&&d.cancel(o),o=d(function(){u.copyqqsuccess=!1},1e3)},u.clickOrg=function(t){"PRIME_QB"===t.source?c.openStore(t.institution_id,null,function(){u.openContactModal(t)}):"QB"===t.source&&c.openQM(t.quote_userid)},u.openContactModal=function(t){s.openModal(t,function(t){i.$emit("institutionOffer",t)})},u.openQM=function(t){c.openQM(t)},u.getContactStatus=function(t){return!0},u.isToday=function(t){return parseInt(t)>u.today},u.gridOptions={enableHorizontalScrollbar:a.scrollbars.NEVER,rowHeight:30,infiniteScrollRowsFromEnd:20,infiniteScrollDown:!0,infiniteScrollUp:!0,onRegisterApi:function(t){t.infiniteScroll.on.needLoadMoreData(i,u.getDataDown),t.infiniteScroll.on.needLoadMoreDataTop(i,u.scrollingTop),u.gridApi=t},rowTemplate:'<div ng-repeat="col in colContainer.renderedColumns track by col.colDef.name" ng-class="{warning:row.entity.isNew, inactive:row.entity.active==0}" class="ui-grid-cell" ui-grid-cell></div>',columnDefs:[{name:"报价方",width:"16%",field:"institution_name",sortDirectionCycle:[a.DESC,a.ASC],cellTemplate:'<div class="ui-grid-cell-contents pointer">                                            <div class="name" ng-if="row.entity.source==\'PRIME_QB\'" >                                                <img class="qm-logo active" src="app/commons/img/qmlogo.png" ng-click="grid.appScope.vm.openContactModal(row.entity)">                                                 <span ng-dblclick="grid.appScope.vm.clickOrg(row.entity)" uib-tooltip="{{row.entity.institution_name}}" tooltip-append-to-body="true" tooltip-animation="false" tooltip-placement="top-left">{{row.entity.institution_name}}</span>                                                 <img src="app/commons/img/primelogo.png"/>                                            </div>                                            <div class="name" ng-if="row.entity.source==\'QB\'">                                                <img ng-click="grid.appScope.vm.openQM(row.entity.quote_userid)" class="qm-logo" ng-class="{active:grid.appScope.vm.getContactStatus(row.entity)}" src="app/commons/img/qmlogo.png">                                                 <span ng-dblclick="grid.appScope.vm.clickOrg(row.entity)" uib-tooltip="{{row.entity.institution_name}}-{{row.entity.quote_username}}" tooltip-append-to-body="true" tooltip-animation="false" tooltip-placement="top-left">                                                    {{row.entity.institution_name}}                                                    <span ng-if="row.entity.institution_name">-</span>                                                {{row.entity.quote_username}}</span>                                            </div>                                            <div class="name QQname" ng-if="row.entity.source==\'QQ\'" ng-click="grid.appScope.vm.clickQQ($event, row.entity)"  uib-tooltip="点击复制QQ号" tooltip-append-to-body="true" tooltip-animation="false" tooltip-placement="top-left"><img class="qq-logo"  src="app/commons/img/qqlogo.png"/>                                                 {{row.entity.institution_name}}                                            </div>                                        </div>'},{name:"联系方式",width:"14%",field:"contact",enableSorting:!1,cellTemplate:'<div uib-dropdown is-open="status.isopen" ng-class="{show:status.isopen}" class="ui-grid-cell-contents cell-contact">                                                <span uib-tooltip="{{grid.appScope.vm.getArray(row.entity.contact)[0] | telFmt:\'3-4-4\'}}" tooltip-append-to-body="true" tooltip-animation="false" tooltip-placement="top-left"><i class="glyphicon glyphicon-earphone" ng-if="grid.appScope.vm.getArray(row.entity.contact)[0]"></i> {{grid.appScope.vm.getArray(row.entity.contact)[0] | telFmt:\'3-4-4\'}}</span>                                                <span ng-if="grid.appScope.vm.getArray(row.entity.contact).length>1" class="btn btn-primary mif-more-vert" uib-dropdown-toggle></span>                                                <ul class="dropdown-menu dropdown-menu-left" uib-dropdown-menu >                                                    <li role="menuitem" ng-repeat="item in grid.appScope.vm.getArray(row.entity.contact) track by $index"><a><i class="glyphicon glyphicon-earphone"></i> {{item | telFmt:\'3-4-4\'}}</a></li>                                                </ul>                                        </div>'},{name:"方向",width:"5%",maxWidth:80,minWidth:50,field:"direction",enableSorting:!1,cellTemplate:'<div class="ui-grid-cell-contents">                                            <div class="badge" ng-class="{\'IN\':\'warning\',\'OUT\':\'info\'}[row.entity.direction]">                                            {{row.entity.direction=="IN" ? "收" : "出"}}</div>                                        </div>'},{name:"类型",width:"8%",field:"quote_type",enableSorting:!1,cellTemplate:'<div class="ui-grid-cell-contents">                                            {{grid.appScope.vm.enumConfig["quoteType"][row.entity.quote_type]}}                                        </div>'},{name:"期限",width:"8%",sortDirectionCycle:[a.DESC,a.ASC],sortingAlgorithm:p.sortTerm,field:"quote_period"},{name:"数量",width:"8%",sortDirectionCycle:[a.DESC,a.ASC],sortingAlgorithm:p.sortCount,field:"quote_quantity"},{name:"价格",width:"8%",sortDirectionCycle:[a.DESC,a.ASC],sortingAlgorithm:p.sortPrice,field:"quote_price"},{name:"备注",width:"*",maxWidth:700,field:"memo",enableSorting:!1,cellTemplate:'<div class="ui-grid-cell-contents">                        <div class="text pointer" uib-tooltip="{{row.entity.memo}}" tooltip-append-to-body="true" tooltip-animation="false" tooltip-placement="top-left">                            {{row.entity.memo}}                        </div></div>'},{name:"最后更新",width:"*",minWidth:160,field:"last_update",sortDirectionCycle:[a.DESC,a.ASC],sort:{direction:a.DESC,priority:1},cellTemplate:'<div class="ui-grid-cell-contents"><span ng-if="grid.appScope.vm.isToday(row.entity.last_update)">{{row.entity.last_update | date: "HH:mm:ss"}}</span><span ng-if="!grid.appScope.vm.isToday(row.entity.last_update)">{{row.entity.last_update | date: " yyyy-MM-dd HH:mm:ss"}}</span></div>'}]},"offline"==u.type&&u.gridOptions.columnDefs.splice(3,1)}];return{restrict:"AE",template:'<div class="back-to-top" ng-click="vm.scrollToTop()" ng-if="vm.showToTop && vm.hasNewData">出现新报价 点击查看</div>                        <div id="market" ui-grid="vm.gridOptions" class="grid" ui-grid-infinite-scroll></div>                        <div id="qqcopy" ng-show="vm.copyqqsuccess" class="copyqqsuccess"><img width="16px" height="16px" src="app/commons/img/true.png" alt=""> 您已成功复制QQ号{{vm.qqnumber}}</div>',controller:t,scope:{list:"=",page:"=",loadData:"&",type:"="},bindToController:!0,controllerAs:"vm",compile:function(){return{pre:function(t,i,e){function o(){var i=t.window.innerHeight,e=t.window.innerWidth;t.location.url().indexOf("/offline")!==-1?e>=1200?n.style.height=i-345+"px":n.style.height=i-375+"px":e>=1200?n.style.height=i-315+"px":n.style.height=i-345+"px"}var n=document.getElementById("market");o(),t.window.onresize=o}}}}})}(angular);