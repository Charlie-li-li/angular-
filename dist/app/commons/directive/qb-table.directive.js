!function(){"use strict";angular.module("directives").directive("qbTable",function(){function t(t,i,e,o,n,l,r,a,s,c,p,d){t.window=p,t.location=d;var u=this,m=new Date;m.setHours(0),m.setMinutes(0),m.setSeconds(0),m.setMilliseconds(0),u.today=m.getTime(),u.enumConfig=n,u.showToTop=!1,u.hasNewData=!1,t.$watch("vm.list",function(t,i){t&&(u.gridOptions.data=t)},!0),u.getDataDown=function(){var t=i.defer();return u.loadData({callback:function(i,e){u.gridApi.infiniteScroll.saveScrollPercentage(),u.gridApi.infiniteScroll.dataLoaded(!0,i<=e).then(function(){t.resolve()})}}),t.promise},u.scrollingTop=function(){u.hasNewData=!1,u.showToTop=!1;var t=i.defer();return u.gridApi.infiniteScroll.saveScrollPercentage(),u.gridApi.infiniteScroll.dataLoaded(!0,!0).then(function(){t.resolve()}),t.promise},u.getArray=function(t){if(t)return t.split(/,|;/)},u.openQM=function(t){a.openQM(t.qb_id)},u.clickOrg=function(i){a.openStore(i.institution_id,null,function(){r.openModal(i,function(i){t.$emit("institutionOffer",i)})})},t.$watch("vm.gridApi.grid.isScrollingVertically",function(t){t&&(u.showToTop=!0)}),t.$on("hasNewData",function(){u.showToTop&&(u.hasNewData=!0)}),u.scrollToTop=function(){u.gridApi.core.scrollTo(u.gridOptions.data[0]),u.showToTop=!1,u.hasNewData=!1},u.isToday=function(t){return parseInt(t)>u.today},u.gridOptions={enableHorizontalScrollbar:l.scrollbars.NEVER,rowHeight:30,infiniteScrollRowsFromEnd:20,infiniteScrollDown:!0,infiniteScrollUp:!0,onRegisterApi:function(i){i.infiniteScroll.on.needLoadMoreData(t,u.getDataDown),i.infiniteScroll.on.needLoadMoreDataTop(t,u.scrollingTop),u.gridApi=i},rowTemplate:'<div ng-repeat="col in colContainer.renderedColumns track by col.colDef.name" ng-class="{warning:row.entity.isNew, inactive:row.entity.active==0}" class="ui-grid-cell" ui-grid-cell></div>',columnDefs:[{name:"机构",width:"10%",field:"institution_name",sortDirectionCycle:[l.DESC,l.ASC],cellTemplate:'<div class="ui-grid-cell-contents pointer">                                            <div class="name" ng-dblclick="grid.appScope.vm.clickOrg(row.entity)" uib-tooltip="{{row.entity.institution_name}}" tooltip-append-to-body="true" tooltip-animation="false" tooltip-placement="top-left">{{row.entity.institution_name}}</div>                                        </div>'},{name:"联系人",width:"10%",field:"quote_user_list",sortDirectionCycle:[l.DESC,l.ASC],cellTemplate:'<div class="ui-grid-cell-contents cell-user-list" uib-dropdown ng-class="{show:status.isopen}" is-open="status.isopen" ng-if="row.entity.quote_user_list.length>0">                                            <span uib-tooltip="{{row.entity.quote_user_list[0].name}}" tooltip-append-to-body="true" tooltip-animation="false" tooltip-placement="top-left"><img src="app/commons/img/qmlogo.png" class="qm-logo pointer active" ng-class="{active : row.entity.quote_user_list[0].status}" ng-click="grid.appScope.vm.openQM(row.entity.quote_user_list[0],row.entity.source)"> {{row.entity.quote_user_list[0].name}}</span>                                            <span class="btn btn-primary mif-more-vert" uib-dropdown-toggle ng-if="row.entity.quote_user_list.length>1"></span>                                            <ul class="dropdown-menu dropdown-menu-left" uib-dropdown-menu role="menu" ng-if="row.entity.quote_user_list.length>1">                                                <li role="menuitem" ng-repeat="item in row.entity.quote_user_list"><a ng-click="grid.appScope.vm.openQM(item,row.entity.source)">                                                <img class="qm-logo active" ng-class="{active : item.status}" src="app/commons/img/qmlogo.png"> {{item.name}}</a></li>                                            </ul>                                    </div>'},{name:"联系方式",width:"14%",field:"contact",enableSorting:!1,cellTemplate:'<div class="ui-grid-cell-contents cell-contact">                                            <span uib-tooltip="{{grid.appScope.vm.getArray(row.entity.contact)[0] | telFmt:\'3-4-4\'}}" tooltip-append-to-body="true" tooltip-animation="false" tooltip-placement="top-left"><i class="glyphicon glyphicon-earphone" ng-if="grid.appScope.vm.getArray(row.entity.contact)[0]"></i> {{grid.appScope.vm.getArray(row.entity.contact)[0] | telFmt:\'3-4-4\'}}</span>                                            <span uib-dropdown ng-if="grid.appScope.vm.getArray(row.entity.contact).length>1">                                                <span class="btn btn-primary mif-more-vert" uib-dropdown-toggle></span>                                                <ul class="dropdown-menu dropdown-menu-right" uib-dropdown-menu >                                                    <li ng-repeat="item in grid.appScope.vm.getArray(row.entity.contact) track by $index"><a>{{item | telFmt:\'3-4-4\'}}</a></li>                                                </ul>                                            </span>                                        </div>'},{name:"方向",width:"5%",maxWidth:80,minWidth:50,field:"direction",enableSorting:!1,cellTemplate:'<div class="ui-grid-cell-contents">                                            <div class="badge" ng-class="{\'IN\':\'warning\',\'OUT\':\'info\'}[row.entity.direction]">                                            {{row.entity.direction=="IN" ? "收" : "出"}}</div>                                        </div>'},{name:"类型",width:"8%",field:"quote_type",enableSorting:!1,cellTemplate:'<div class="ui-grid-cell-contents">                                            {{grid.appScope.vm.enumConfig["quoteType"][row.entity.quote_type]}}                                        </div>'},{name:"期限",width:"8%",sortDirectionCycle:[l.DESC,l.ASC],sortingAlgorithm:c.sortTerm,field:"quote_period"},{name:"数量",width:"8%",sortDirectionCycle:[l.DESC,l.ASC],sortingAlgorithm:c.sortCount,field:"quote_quantity"},{name:"价格",width:"8%",sortDirectionCycle:[l.DESC,l.ASC],sortingAlgorithm:c.sortPrice,field:"quote_price"},{name:"备注",width:"*",maxWidth:700,field:"memo",enableSorting:!1,cellTemplate:'<div class="ui-grid-cell-contents">                        <div class="text pointer" uib-tooltip="{{row.entity.memo}}" tooltip-append-to-body="true" tooltip-animation="false" tooltip-placement="top-left">                            {{row.entity.memo}}                        </div></div>'},{name:"最后更新",width:"*",minWidth:160,field:"last_update",sortDirectionCycle:[l.DESC,l.ASC],sort:{direction:l.DESC,priority:1},cellTemplate:'<div class="ui-grid-cell-contents"><span ng-if="grid.appScope.vm.isToday(row.entity.last_update)">{{row.entity.last_update | date: "HH:mm:ss"}}</span><span ng-if="!grid.appScope.vm.isToday(row.entity.last_update)">{{row.entity.last_update | date: " yyyy-MM-dd HH:mm:ss"}}</span></div>'}]},"offline"==u.type&&u.gridOptions.columnDefs.splice(4,1)}return t.$inject=["$scope","$q","$http","appConfig","enumConfig","uiGridConstants","contactService","qbService","offerService","sortService","$window","$location"],{restrict:"AE",template:'<div class="back-to-top" ng-click="vm.scrollToTop()" ng-if="vm.showToTop && vm.hasNewData">出现新报价 点击查看</div>                        <div id="qb" ui-grid="vm.gridOptions" class="grid" ui-grid-infinite-scroll></div>',scope:{list:"=",page:"=",loadData:"&",type:"="},controller:t,bindToController:!0,controllerAs:"vm",compile:function(){return{pre:function(t,i,e){function o(){var i=t.window.innerHeight,e=t.window.innerWidth;t.location.url().indexOf("/offline")!==-1?e>=1200?n.style.height=i-345+"px":n.style.height=i-375+"px":e>=1200?n.style.height=i-315+"px":n.style.height=i-345+"px"}var n=document.getElementById("qb");o(),t.window.onresize=o}}}}})}();