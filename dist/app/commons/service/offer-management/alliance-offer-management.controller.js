!function(e){"use strict";e.module("services").controller("allianceOfferManageController",["$scope","$uibModal","$uibModalInstance","$http","$timeout","commonService","bootbox","offerService","tabNavigatorService","appConfig","enumConfig","offerConfirm","quoteQuery","allianceQuery",function(t,i,o,n,a,r,d,s,l,u,c,f,v,p){function m(t,i){return e.copy({seqNo:void 0,type:t,methodType:q.quoteMethod,institutionInfo:i,boardDir:s.dataDefine.boardDirection.findItem(function(e){return e.value===t.direction}),periodList:q.periodList,remark:"",active:s.dataDefine.activeDefine["true"]})}function y(e,t){return e.type&&t.type?e.id-t.id:e.type&&!t.type?-1:!e.type&&t.type?1:e.daysLowValue-t.daysLowValue}function h(){q.boardList&&q.boardList.findWhere(function(e){return 0!==e.active&&e.type.value===q.selectType.value}).forEach(function(e,t){e.periodList&&!(e.periodList.length<=0)&&e.periodList instanceof Array&&e.periodList.forEach(function(e,i){e.tabIndex=t*(q.periodList.length+2)+1+i})})}function L(t){t.forEach(function(t,i){var o=s.boardFactory(t,q.periodList,p);o.seqNo=t.sequence,o.methodType=q.quoteMethod,o.type=N.typeListDefine.findItem(function(e){return e.value===t.quoteType}),q.boardList.forEach(function(t,i){t.periodList&&t.periodList.length<o.periodList.length&&t.periodList.push.apply(t.periodList,e.copy(q.periodList).slice(t.periodList.length-o.periodList.length))}),o.type&&q.boardList.push(o)}),q.boardList.sort(function(e,t){return e.displayOrder-t.displayOrder}),q.periodList.sort(y),q.boardList.forEach(function(e,t){e.periodList.sort(y)}),h()}function g(e){n.post(u.post_board,{offer_data:e}).then(function(t){t&&t.data&&0===t.data.return_code?o.close(e):console.log("sendBoardList error",t)},function(t){t&&t.data&&0===t.data.return_code?o.close(e):console.log("sendBoardList error",t)})}function b(e){var t=T?u.post_saveExcel:u.post_alliance_board;n.post(t,{offer_data:e}).then(function(t){t&&t.data&&0===t.data.return_code?o.close(e):console.log("sendAllianceBoardList error",t)},function(t){t&&t.data&&0===t.data.return_code?o.close(e):console.log("sendAllianceBoardList error",t)})}function D(){var e=m(q.selectType),t=0;q.boardList.forEach(function(e,i){delete e.isQuoted,e.seqNo>t&&(t=e.seqNo)}),e.seqNo=t+1,q.boardList.push(e),h()}function I(){if(c&&c.quoteMethod&&(c.quoteMethod[0]===N.quoteMethodDefine[1].value||c.quoteMethod[0]===N.quoteMethodDefine[2].value)){var e=i.open({animation:!1,templateUrl:"app/commons/service/offer-management/allianceAddQuote.html",size:"sm",backdrop:"static",controller:"allianceAddQuoteController",bindToController:!0,resolve:{load:["$ocLazyLoad",function(e){return e.load([])}],getAlliance:[function(){return p}],addedBoard:[function(){return q.boardList.findWhere(function(e){return e&&0!==e.active}).map(function(e){return e.institutionInfo})}],getBrotherAlliance:[function(){}]}});return void e.result.then(function(e){if(e){var t=e.map(function(e){return m(q.selectType,e)}).sort(function(e,t){return e.institutionInfo.displayOrder-t.institutionInfo.displayOrder});t.forEach(function(e,t){var i=q.boardList.lastIndexOfItem(function(t){return t.institutionInfo.displayOrder===e.institutionInfo.displayOrder});i>=q.boardList.length-1||void 0===i?q.boardList.push(e):q.boardList.splice(i+1,0,e)});var i=0,o=void 0;q.boardList.forEach(function(e,t){delete e.isQuoted,e.institutionInfo&&e.institutionInfo.displayOrder!==-1&&(o?o===e.institutionInfo.institutionId?e.seqNo?i=e.seqNo:e.seqNo=++i:(e.seqNo?i=e.seqNo:(i=0,e.seqNo=++i),o=e.institutionInfo.institutionId):(e.seqNo?i=e.seqNo:e.seqNo=++i,o=e.institutionInfo.institutionId))}),h()}},function(e){})}q.boardList.push(m(q.selectType,item))}var N={quoteMethodDefine:[{displayName:"普通报价",value:"SEF"},{displayName:"联盟报价",value:"ALC"},{displayName:"代报价",value:"BRK"}],typeListDefine:[{displayName:"同存",value:"IBD",direction:"IN"},{displayName:"保本",value:"GTF",direction:"OUT"},{displayName:"非保本R2",value:"UR2",direction:"OUT"},{displayName:"非保本R3",value:"UR3",direction:"OUT"}],dto:{saveQuote:{id:"id",quoteType:"type.value",direction:"boardDir.value",methodType:"methodType.value",memo:"remark",institutionId:"institutionInfo.institutionId",sequence:"seqNo",active:"active"},saveQuoteQuoteDetailsVO:{limitType:"type",price:"period"},saveQuoteSpQuoteDetailsVO:{dayHigh:"daysHighValue",dayLow:"daysLowValue",price:"period"}}},q=this,T=!1;q.boardListFilter=function(e,t,i){return q.selectType.value===e.type.value&&e.active!==s.dataDefine.activeDefine["false"]},q.initTableHeader=function(){console.log("initTableHeader")},q.onClickBoardDirection=function(e,t){if(console.log("onClickBoardDirection"),e&&e.target&&"BUTTON"===e.target.nodeName){var i=q.boardDirectionList.indexOfItem(function(e){return e.value===t.boardDir.value&&e.displayName===t.boardDir.displayName});t.boardDir=q.boardDirectionList[(i+1)%q.boardDirectionList.length]}},q.onClickQuoteType=function(t){if(t&&t.target){if("A"===t.target.nodeName){var i=e.element(t.target).scope();i&&(q.selectType=i.item)}h()}},q.onKeydownTable=function(i){i&&i.target&&("BUTTON"!==i.target.nodeName||i.target.className.indexOf("badge")<0||9===i.keyCode&&(i.cancelBubble=!0,l.findNextTd(i,function(i){var o=e.element(i).controller("editable");return o?(o.isEditing=!0,a(function(){$(i).addClass("is-editing"),$(i).find("input").focus()}),void o.textChanged()):void t.$emit("onTabNavigating",i)})))},q.onClickDeleteRow=function(e){if(e){var t=q.boardList.indexOfItem(function(t){return e.id?t.id===e.id:!(!t.institutionInfo||!e.institutionInfo)&&(t.seqNo===e.seqNo&&t.institutionInfo.institutionId===e.institutionInfo.institutionId)});t>=0&&(q.boardList[t].id?q.boardList[t].active=s.dataDefine.activeDefine["false"]:q.boardList.splice(t,1)),h()}},q.onClickUploadExcel=function(t){if(t&&!(t.length<=0)){var i=t[0];if(!i.name.endWith(".xls")&&!i.name.endWith(".xlsx"))return void d.message("请选择Excel文件（*.xls 或 *.xlsx）");var o=new FileReader;o.onload=function(t){var a={data:o.result,fileName:i.name};n.post(u.post_uploadExcel,a).then(function(t){if(t&&t.data.result&&t.data.result.length>0){if(t.data.result[0].error&&t.data.result[0].error.length>0){var i="导入发生错误。在Excel中</br>",o="",n=void 0;t.data.result[0].error.findWhere(function(e){return"DATA_MISSING"===e.validationErrorType}).forEach(function(e,t){o+="{0}, ".format(e.sourceField),n=e.detailMsg}),""!==o&&(o=o.substring(0,o.lastIndexOf(", ")),i+="<div>第 {0} 处, {1}。</br></div>".format(o,n)),o="",t.data.result[0].error.findWhere(function(e){return"DATA_MISSING"!==e.validationErrorType}).forEach(function(e,t){o+="{0}, ".format(e.sourceField),n=e.detailMsg}),""!==o&&(o=o.substring(0,o.lastIndexOf(", ")),i+="<div>第 {0} 行, {1}。</div>".format(o,n)),t.data.result[0].error.findWhere(function(e){return"DATA_MISSING"===e.validationErrorType}).length>0&&(i+="</br>注： {4,3} 代表第4行第3列。</br>"),d.messageHtml(void 0,i)}return q.periodList=e.copy(s.dataDefine.periodDefine),q.boardList=[],T=!0,void L(t.data.result[0].fileContent)}d.message("导入发生错误， 请修改一下再试试吧！")},function(e){if(e&&e.status===-1)return e.data&&e.data.return_message?void d.message("导入Excel错误："+e.data.return_message):void d.message("导入Excel错误。")})},o.readAsDataURL(i),h()}},q.cancel=function(){o.dismiss()},q.onClickSaveQuote=function(){if(!q.boardList||q.boardList.length<=0)return void o.close();var e=q.boardList.findWhere(function(e){return e.id||e.active!==s.dataDefine.activeDefine["false"]}).map(function(e){var t=r.getDto(e,N.dto.saveQuote);return t.source="QB",t.quoteDetailsDtos=e.periodList.map(function(t){t.period=parseFloat(t.period);var i=void 0;return t.id?i=r.getDto(t,N.dto.saveQuoteQuoteDetailsVO):(t.isRange||(t.daysHighValue=t.daysLowValue),i=r.getDto(t,N.dto.saveQuoteSpQuoteDetailsVO)),e.active===s.dataDefine.activeDefine["false"]&&(i.active=e.active),i}),t});q.isAllianceBoardable()?b(e):g(e)},t.$on("onTabNavigating",function(e,t){console.log("onTabNavigating event handled."),!t||t.length<=0}),q.onClickAddPeriod=function(){var t=i.open({animation:!1,templateUrl:"app/commons/service/offer-management/allianceAddSpPeriod.html",size:"350px",backdrop:"static",controller:"allianceAddSpPeriodController",bindToController:!0,resolve:{load:["$ocLazyLoad",function(e){return e.load([])}]}});t.result.then(function(t){if(t&&!(q.periodList.indexOfItem(function(e){return s.isSameSpPeriod(e,t)})>=0)){var i=e.copy(t);s.setSpPeriodHeader(i),q.periodList.push(i),q.periodList.sort(y),q.boardList.forEach(function(t,o){t.periodList.push(e.copy(i)),t.periodList.sort(y)}),h()}},function(e){})},q.onClickDeletePeriod=function(e){q.periodList=q.periodList.findWhere(function(t){return!!t.id||t.daysLowValue!==e.daysLowValue}),q.boardList.forEach(function(t){t.periodList=t.periodList.findWhere(function(t){return!!t.id||t.daysLowValue!==e.daysLowValue})}),h()},q.isAllianceBoardable=function(){return!(!c||!c.quoteMethod)&&(c.quoteMethod[0]===N.quoteMethodDefine[1].value||c.quoteMethod[0]===N.quoteMethodDefine[2].value)},q.onClickAddQuote=function(){return q.isAllianceBoardable()?I:D}();(function(){if(q.periodList=e.copy(s.dataDefine.periodDefine),q.boardDirectionList=s.dataDefine.boardDirection,q.typeList=N.typeListDefine,c&&c.quoteMethod){var t=N.quoteMethodDefine.findItem(function(e){return e.value===c.quoteMethod[0]});q.quoteMethod=t?t:N.quoteMethodDefine[0]}else q.quoteMethod=N.quoteMethodDefine[0];q.selectType=q.typeList[0],q.boardList=[],v&&v.result&&v.result[0]&&v.result[0].offer_data&&v.result[0].offer_data.length>0&&L(v.result[0].offer_data),h(),T=!1})()}]),e.module("services").controller("allianceAddSpPeriodController",["$scope","$uibModalInstance","$http","appConfig",function(e,t,i,o){function n(e,t){if(!t)return e;switch(t){case"d":return e;case"M":return 30*e;case"y":return 30*e*12;default:return e}}var a={rangeFlagEnum:[{displayName:"非区间期限",value:!1},{displayName:"区间期限",value:!0}],daysUnitEnum:[{displayName:"日",value:"d"},{displayName:"月",value:"M"},{displayName:"年",value:"y"}]};e.onClickCancel=function(){t.dismiss()},e.onClickOk=function(){var i=!0;e.vm.daysLow||(e.vaildDaysLow=!0,i=!1),!e.vm.daysHigh&&e.vm.isRange&&(e.vaildDaysHigh=!0,i=!1),n(+e.vm.daysHigh,e.vm.daysHighUnit)<=n(+e.vm.daysLow,e.vm.daysLowUnit)&&(e.vaildDaysLow=!0,e.vaildDaysHigh=!0,i=!1),0===+e.vm.daysLow&&(e.vaildDaysLow=!0,i=!1),i&&(e.vm.daysLow=+e.vm.daysLow,t.close(e.vm))},e.onChangeRange=function(){e.vm.daysLow=void 0,e.vm.daysHigh=void 0,e.vaildDaysLow=!1,e.vaildDaysHigh=!1},e.onClickDaysUnit=function(){};(function(){e.rangeFlagEnum=a.rangeFlagEnum,e.daysUnitEnum=a.daysUnitEnum,e.vm={daysLowUnit:void 0,daysHighUnit:void 0},e.vm.daysHighUnit=a.daysUnitEnum[0].value,e.vm.daysLowUnit=a.daysUnitEnum[0].value,e.vm.__defineGetter__("daysHighValue",function(){return n(this.daysHigh,this.daysHighUnit)}),e.vm.__defineGetter__("daysLowValue",function(){return n(this.daysLow,this.daysLowUnit)}),e.vm.isRange=!1})()}]),e.module("services").controller("allianceAddQuoteController",["$scope","$uibModalInstance","$http","appConfig","getAlliance","getBrotherAlliance","addedBoard",function(e,t,i,o,n,a,r){e.selectedCount=0,e.onClickAlliance=function(){return e.vm&&e.vm.allianceList?void(e.selectedCount=e.vm.allianceList.findWhere(function(e){return e.isSelected}).length):void(e.selectedCount=0)},e.cancel=function(){e.vm.allianceList&&e.vm.allianceList.length>0&&e.vm.allianceList.forEach(function(e,t){delete e.isSelected,r.findItem(function(t){return t.institutionId===e.institutionId})&&(e.isQuoted=!0)}),t.dismiss()},e.addQuote=function(){var i=e.vm.allianceList.findWhere(function(e){return e.isSelected});t.close(i)};(function(){e.vm={},n&&n.result&&n.result.length>0&&(e.vm.allianceList=n.result[0].alliance,e.vm.allianceList.forEach(function(t,i){delete t.isSelected,r&&r.length>0&&e.vm.allianceList.length>0&&r.findItem(function(e){return e.institutionId===t.institutionId})?t.isQuoted=!0:delete t.isQuoted})),a&&a.result&&a.result>0&&(e.vm.brotherAllianceList=a.result[0])})()}])}(angular);