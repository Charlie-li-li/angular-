!function(e){"use strict";function t(t,i,n,r,a,o,d,s,c,u){function f(e){e||(e=7);var t=new Date,i=new Date;return t.setTime(i.getTime()+24*(e-1)*3600*1e3),t.setHours(23),t.setMinutes(0),t.setSeconds(0),t.format("yyyy-mm-dd HH:MM:ss")}function p(t){return{type:e.copy(t),periodList:[],spaceList:e.copy(v.periodList),remark:void 0,active:o.dataDefine.activeDefine["true"],expiredDate:7,expiredDateString:f(7),boardDir:v.boardDirectionList.findItem(function(e){return e.value===t.direction})}}function l(){v.selectedTypeList&&(v.selectedTypeList.forEach(function(e,t){e.periodList&&e.periodList.forEach(function(e,t){e.tabIndex=2*t})}),a.safeApply(i))}function m(t){D=t,t.forEach(function(t,n){var r={id:t.id,seqNo:t.sequence,type:v.typeList.findItem(function(e){return e["enum"]===t.quoteType}),active:o.dataDefine.activeDefine["true"],remark:t.memo,expiredDate:t.valideDays?t.valideDays:7};r.expiredDateString=f(r.expiredDate),r.boardDir=v.boardDirectionList.findItem(function(e){return e.value===t.direction});var d=e.copy(v.periodList);r.periodList=[],r.spaceList=[];for(var s in d)if("function"!=typeof d[s]){var c=!1,u=t.quoteDetailsDtos;for(var p in u)"function"!=typeof u[p]&&d[s]["enum"]==u[p].limitType&&(c=!0,d[s].value=u[p].price,u[p].quantity&&(d[s].amount=u[p].quantity,r.showAmount=!0),d[s].id=u[p].id,r.periodList.push(d[s]));c||r.spaceList.push(d[s])}v.selectedTypeList.push(r),a.safeApply(i)})}function y(e){return n.post("quote/save",{offer_data:e})}var v=this;v.typeList=[{name:"同存","enum":"IBD",direction:"IN"},{name:"保本","enum":"GTF",direction:"OUT"},{name:"非保本R2","enum":"UR2",direction:"OUT"},{name:"非保本R3","enum":"UR3",direction:"OUT"}],v.periodList=[{displayOrder:1,period:"7D","enum":"T7D"},{displayOrder:2,period:"14D","enum":"T14D"},{displayOrder:3,period:"1M","enum":"T1M"},{displayOrder:4,period:"2M","enum":"T2M"},{displayOrder:5,period:"3M","enum":"T3M"},{displayOrder:6,period:"6M","enum":"T6M"},{displayOrder:7,period:"9M","enum":"T9M"},{displayOrder:8,period:"1Y","enum":"T1Y"}],v.selectedTypeList=[],v.boardDirectionList=o.dataDefine.boardDirection;var D;v.onKeydownTable=function(t){t&&t.target&&("BUTTON"!==t.target.nodeName||t.target.className.indexOf("badge")<0||9===t.keyCode&&(t.cancelBubble=!0,d.findNextTd(t,function(t){var n=e.element(t).controller("editable");return n?(n.isEditing=!0,r(function(){$(t).addClass("is-editing"),$(t).find("input").focus()}),void n.textChanged()):void i.$emit("onTabNavigating",t)})))};(function(){if(u.result&&u.result.length>0){var e=u.result[0].offer_data;m(e)}v.selectType=v.typeList[0],l()})();v.onClickBoardDirection=function(e,t){if(e&&e.target&&"BUTTON"===e.target.nodeName){var i=v.boardDirectionList.indexOfItem(function(t){return t.displayName===e.target.innerHTML});t.boardDir=v.boardDirectionList[i]}},v.onClickQuoteType=function(t){if(t&&t.target&&"A"===t.target.nodeName){var i=e.element(t.target).scope();i&&(v.selectType=i.item)}},v.boardListFilter=function(e,t,i){return v.selectType["enum"]===e.type["enum"]&&e.active!==o.dataDefine.activeDefine["false"]},v.periodFilter=function(e,t,i){return e.active!==o.dataDefine.activeDefine["false"]},v.deleteType=function(e){e.id?(e.active=o.dataDefine.activeDefine["false"],e.periodList.forEach(function(e){e.active=o.dataDefine.activeDefine["false"]})):v.selectedTypeList=v.selectedTypeList.findWhere(function(t){return t.$$hashKey!==e.$$hashKey}),l()},v.deletePeriod=function(e,t){t.active=o.dataDefine.activeDefine["false"],t.value=null,t.amount=null,e.spaceList.push(t),e.spaceList.sort(function(e,t){return e.displayOrder-t.displayOrder}),l()},v.addPeriod=function(e,t){var i=e.spaceList.findIndex(function(e){return e["enum"]===t["enum"]});e.spaceList.splice(i,1);var n=e.periodList.findItem(function(e){return e["enum"]===t["enum"]});n?n.active=o.dataDefine.activeDefine["true"]:e.periodList.push(t),e.periodList.sort(function(e,t){return e.displayOrder-t.displayOrder}),l()},v.onClickAddQuote=function(){var e=p(v.selectType),t=0;v.selectedTypeList.forEach(function(e,i){e.seqNo>t&&(t=e.seqNo)}),e.seqNo=t+1,v.selectedTypeList.push(e),l()},v.showAmount=function(e){e.showAmount=!0},v.hideAmount=function(e){e.showAmount=!1,e.periodList.forEach(function(e,t){delete e.amount})},v.onChangedExpiredDate=function(e,t){(t.expiredDate<=0||t.expiredDate>30)&&(t.expiredDate=""),t.expiredDateString=f(t.expiredDate)},v.save=function(){v.selectedTypeList.forEach(function(e,t){e.periodList=e.periodList.findWhere(function(e){return e.active!==o.dataDefine.activeDefine["false"]})}),c.confirm(v.selectedTypeList.findWhere(function(e){return e.active!==o.dataDefine.activeDefine["false"]}),function(){for(var e=v.selectedTypeList.map(function(e){return{id:e.id,quoteType:e.type["enum"],direction:e.boardDir.value,memo:e.remark,quoteDetailsDtos:e.periodList.map(function(t){var i={id:t.id,limitType:t["enum"],price:parseFloat(t.value),quantity:t.amount,active:e.active};return t.active===o.dataDefine.activeDefine["false"]&&(i.active=t.active),i}),sequence:e.seqNo,source:"QB",valideDays:e.expiredDate}}),i=0;i<D.length;i++){for(var n=!1,r=0;r<e.length;r++)if(D[i].quoteType==e[r].quoteType){n=!0;break}n||(delete D[i].quoteUserId,D[i].quoteDetailsDtos=[],e.push(D[i]))}y(e).success(function(i){t.close(e)})})},v.cancel=function(){t.dismiss()}}e.module("services").controller("offerManageController",t),t.$inject=["$uibModalInstance","$scope","$http","$timeout","commonService","offerService","tabNavigatorService","appConfig","offerConfirm","quoteQuery"]}(angular);